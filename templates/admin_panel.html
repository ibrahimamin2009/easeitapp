{% extends "base.html" %}

{% block title %}Admin Panel - Order Management System{% endblock %}

{% block content %}
<div class="admin-panel-container">
    <div class="admin-header">
        <div class="header-content">
            <h1><i class="fas fa-users-cog"></i> Admin Panel</h1>
            <p class="header-subtitle">Manage users, orders, and system settings</p>
        </div>
        <div class="admin-actions">
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to Dashboard
            </a>
            <a href="{{ url_for('register') }}" class="btn btn-primary">
                <i class="fas fa-user-plus"></i>
                Add User
            </a>
        </div>
    </div>
    
    <div class="admin-content">
        <!-- User Management -->
        <div class="admin-section">
            <div class="section-header">
                <h2><i class="fas fa-users"></i> User Management</h2>
                <div class="section-actions">
                    <span class="user-count">{{ users|length }} users</span>
                </div>
            </div>
            <div class="users-grid">
                {% for user in users %}
                <div class="user-card">
                    <div class="user-header">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-info">
                            <h3>{{ user.username }}</h3>
                            <p>{{ user.email }}</p>
                        </div>
                        <div class="user-status">
                            <span class="status-badge {% if user.is_active %}status-active{% else %}status-inactive{% endif %}">
                                {% if user.is_active %}Active{% else %}Inactive{% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="user-details">
                        <div class="detail-item">
                            <span class="label">Role:</span>
                            <span class="role-badge role-{{ user.role }}">{{ user.role.title() }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Created:</span>
                            <span class="value">{{ user.created_at.strftime('%m/%d/%Y') }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Orders:</span>
                            <span class="value">{{ user.created_orders|length }} created</span>
                        </div>
                    </div>
                    <div class="user-actions">
                        <a href="{{ url_for('edit_user', user_id=user.id) }}" class="btn btn-sm btn-primary" title="Edit User">
                            <i class="fas fa-edit"></i>
                            Edit
                        </a>
                        {% if user.id != session.user_id %}
                        {% if user.is_active %}
                        <button class="btn btn-sm btn-warning" onclick="updateUser({{ user.id }}, 'deactivate')" title="Deactivate User">
                            <i class="fas fa-user-times"></i>
                            Deactivate
                        </button>
                        {% else %}
                        <button class="btn btn-sm btn-success" onclick="updateUser({{ user.id }}, 'activate')" title="Activate User">
                            <i class="fas fa-user-check"></i>
                            Activate
                        </button>
                        {% endif %}
                        {% else %}
                        <span class="current-user">Current User</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Unassigned Orders -->
        <div class="admin-section">
            <div class="section-header">
                <h2><i class="fas fa-exclamation-triangle"></i> Unassigned Orders</h2>
                <div class="section-actions">
                    <span class="unassigned-count">{{ unassigned_orders|length }} unassigned</span>
                </div>
            </div>
            {% if unassigned_orders %}
            <div class="unassigned-orders-grid">
                {% for order in unassigned_orders %}
                <div class="unassigned-card">
                    <div class="card-header">
                        <div class="order-id">
                            <h4>{{ order.order_id }}</h4>
                            <span class="order-status status-{{ order.status|lower|replace(' ', '-') }}">{{ order.status }}</span>
                        </div>
                        <div class="order-priority">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="order-info">
                            <div class="info-item">
                                <i class="fas fa-user"></i>
                                <span>{{ order.customer_name }}</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-dollar-sign"></i>
                                <span>${{ "%.2f"|format(order.amount_usd) }}</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-calendar"></i>
                                <span>{{ order.created_at.strftime('%m/%d/%Y') }}</span>
                            </div>
                        </div>
                        <div class="order-details">
                            <div class="detail-row">
                                <span class="label">Yarn Type:</span>
                                <span class="value">{{ order.yarn_type }}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Quantity:</span>
                                <span class="value">{{ order.quantity_kg }} kg</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Type:</span>
                                <span class="value">{{ order.order_type }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-primary" onclick="openAssignModal({{ order.id }})">
                            <i class="fas fa-user-plus"></i>
                            Assign Agent
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="no-unassigned">
                <div class="no-data-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3>All Orders Assigned</h3>
                <p>Great job! All orders have been assigned to agents.</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Order Management -->
        <div class="admin-section">
            <div class="section-header">
                <h2><i class="fas fa-shopping-cart"></i> Order Management</h2>
                <div class="section-actions">
                    <span class="order-count">{{ all_orders|length }} total orders</span>
                </div>
            </div>
            {% if all_orders %}
            <div class="orders-table-container">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Yarn Type</th>
                            <th>Quantity</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Assigned To</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in all_orders %}
                        <tr>
                            <td>
                                <strong>{{ order.order_id }}</strong>
                            </td>
                            <td>{{ order.customer_name }}</td>
                            <td>{{ order.yarn_type }}</td>
                            <td>{{ order.quantity_kg }} kg</td>
                            <td>${{ "%.2f"|format(order.amount_usd) }}</td>
                            <td>
                                <span class="status-badge status-{{ order.status|lower|replace(' ', '-') }}">
                                    {{ order.status }}
                                </span>
                            </td>
                            <td>{{ order.created_at.strftime('%m/%d/%Y') }}</td>
                            <td>
                                {% if order.agent %}
                                    <span class="assigned-agent">{{ order.agent.username }}</span>
                                {% else %}
                                    <span class="unassigned">Not assigned</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="order-actions">
                                    <a href="{{ url_for('edit_order', order_id=order.id) }}" class="btn btn-sm btn-primary" title="Edit Order">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{{ url_for('chat', order_id=order.id) }}" class="btn btn-sm btn-info" title="View Chat">
                                        <i class="fas fa-comments"></i>
                                    </a>
                                    <button class="btn btn-sm btn-danger" onclick="deleteOrder({{ order.id }})" title="Delete Order">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="no-orders">
                <div class="no-data-icon">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <h3>No Orders Found</h3>
                <p>There are no orders in the system yet.</p>
            </div>
            {% endif %}
        </div>
        
        <!-- System Statistics -->
        <div class="admin-section">
            <div class="section-header">
                <h2><i class="fas fa-chart-bar"></i> System Statistics</h2>
                <div class="section-actions">
                    <a href="{{ url_for('admin_stats') }}" class="btn btn-sm btn-secondary">
                        <i class="fas fa-chart-line"></i>
                        Detailed Stats
                    </a>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card stat-primary">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ users|length }}</h3>
                        <p>Total Users</p>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up"></i>
                            <span>Active system</span>
                        </div>
                    </div>
                </div>
                <div class="stat-card stat-success">
                    <div class="stat-icon">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ users|selectattr('role', 'equalto', 'agent')|list|length }}</h3>
                        <p>Agents</p>
                        <div class="stat-trend">
                            <i class="fas fa-users"></i>
                            <span>Available</span>
                        </div>
                    </div>
                </div>
                <div class="stat-card stat-info">
                    <div class="stat-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ users|selectattr('role', 'equalto', 'user')|list|length }}</h3>
                        <p>Regular Users</p>
                        <div class="stat-trend">
                            <i class="fas fa-shopping-cart"></i>
                            <span>Order creators</span>
                        </div>
                    </div>
                </div>
                <div class="stat-card stat-warning">
                    <div class="stat-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ unassigned_orders|length }}</h3>
                        <p>Unassigned Orders</p>
                        <div class="stat-trend">
                            {% if unassigned_orders|length > 0 %}
                            <i class="fas fa-exclamation-circle"></i>
                            <span>Needs attention</span>
                            {% else %}
                            <i class="fas fa-check-circle"></i>
                            <span>All assigned</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assign Agent Modal -->
<div id="assignModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Assign Agent</h2>
            <span class="close" onclick="closeAssignModal()">&times;</span>
        </div>
        <form id="assignForm">
            <input type="hidden" id="assignOrderId">
            <div class="form-group">
                <label for="assignAgent">Select Agent</label>
                <select id="assignAgent" name="agent_id" required>
                    <option value="">Select Agent</option>
                    {% for user in users %}
                    {% if user.role == 'agent' %}
                    <option value="{{ user.id }}">{{ user.username }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeAssignModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Assign Agent</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function updateUser(userId, action) {
    if (confirm(`Are you sure you want to ${action} this user?`)) {
        fetch('/update_user', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: userId,
                action: action
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            alert('Error updating user');
            console.error('Error:', error);
        });
    }
}

function openAssignModal(orderId) {
    document.getElementById('assignOrderId').value = orderId;
    document.getElementById('assignModal').style.display = 'block';
}

function closeAssignModal() {
    document.getElementById('assignModal').style.display = 'none';
    document.getElementById('assignForm').reset();
}

document.getElementById('assignForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const orderId = document.getElementById('assignOrderId').value;
    const agentId = document.getElementById('assignAgent').value;
    
    fetch('/assign_order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            order_id: orderId,
            agent_id: agentId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message);
        }
    });
});

function deleteOrder(orderId) {
    if (confirm('Are you sure you want to delete this order? This action cannot be undone and will also delete all related chat messages, contracts, and audit logs.')) {
        fetch('/delete_order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                order_id: orderId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Order deleted successfully');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting order');
        });
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const assignModal = document.getElementById('assignModal');
    if (event.target == assignModal) {
        closeAssignModal();
    }
}
</script>
{% endblock %}
