{% extends "base.html" %}

{% block title %}Confirm Order - {{ order.order_id }} - Order Management System{% endblock %}

{% block content %}
<div class="confirm-order-container">
    <div class="confirm-order-header">
        <h1><i class="fas fa-check-circle"></i> Confirm Order</h1>
        <div class="order-info">
            <h2>{{ order.order_id }}</h2>
            <div class="order-details">
                <div class="detail-row">
                    <span class="label">Customer:</span>
                    <span class="value">{{ order.customer_name }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Yarn Type:</span>
                    <span class="value">{{ order.yarn_type }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Quantity:</span>
                    <span class="value">{{ order.quantity_kg }} kg</span>
                </div>
                <div class="detail-row">
                    <span class="label">Order Type:</span>
                    <span class="value">{{ order.order_type }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Amount:</span>
                    <span class="value">${{ "%.2f"|format(order.amount_usd) }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Status:</span>
                    <span class="value">{{ order.status }}</span>
                </div>
            </div>
        </div>
        <div class="confirm-actions">
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to Dashboard
            </a>
        </div>
    </div>
    
    <div class="confirm-content">
        <div class="confirmation-message">
            <h3><i class="fas fa-exclamation-triangle"></i> Order Confirmation Required</h3>
            <p>This order is ready to be confirmed. Please select ONE agent from the assigned agents below. Once confirmed, only the selected agent will be able to see and work on this order.</p>
        </div>
        
        <div class="agent-selection">
            <h3>Select Agent for Confirmed Order:</h3>
            <form id="confirmForm" class="confirm-form">
                <input type="hidden" id="orderId" value="{{ order.id }}">
                <div class="agent-options">
                    {% for agent in agents %}
                    <label class="agent-option">
                        <input type="radio" name="selected_agent" value="{{ agent.id }}" required>
                        <div class="agent-card">
                            <div class="agent-info">
                                <h4>{{ agent.username }}</h4>
                                <p>{{ agent.email }}</p>
                            </div>
                        </div>
                    </label>
                    {% endfor %}
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i>
                        Confirm Order & Assign Agent
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const confirmForm = document.getElementById('confirmForm');
    
    confirmForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const orderId = document.getElementById('orderId').value;
        const selectedAgent = document.querySelector('input[name="selected_agent"]:checked');
        
        if (!selectedAgent) {
            alert('Please select an agent');
            return;
        }
        
        // Disable form temporarily
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Confirming...';
        submitBtn.disabled = true;
        
        fetch('/confirm_order_action', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                order_id: orderId,
                selected_agent_id: selectedAgent.value
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Order confirmed successfully!');
                window.location.href = '/dashboard';
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error confirming order');
            console.error('Error:', error);
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });
});
</script>

<style>
.confirm-order-container {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    min-height: 600px;
    max-height: calc(100vh - 200px);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.confirm-order-header {
    padding: 2rem;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.confirm-order-header h1 {
    font-size: 2rem;
    color: #333;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.order-info h2 {
    font-size: 1.5rem;
    color: #667eea;
    margin-bottom: 0.5rem;
}

.order-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.detail-row {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.detail-row .label {
    font-weight: 600;
    color: #666;
    font-size: 0.9rem;
}

.detail-row .value {
    color: #333;
    font-size: 1rem;
}

.confirm-content {
    flex: 1;
    padding: 2rem;
    overflow-y: auto;
}

.confirmation-message {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.confirmation-message h3 {
    color: #856404;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.confirmation-message p {
    color: #856404;
    margin: 0;
    line-height: 1.5;
}

.agent-selection h3 {
    color: #333;
    margin-bottom: 1.5rem;
    font-size: 1.2rem;
}

.agent-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.agent-option {
    cursor: pointer;
    display: block;
}

.agent-option input[type="radio"] {
    display: none;
}

.agent-card {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 15px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    height: 100%;
}

.agent-option input[type="radio"]:checked + .agent-card {
    border-color: #667eea;
    background: #f8f9ff;
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
}

.agent-card:hover {
    border-color: #667eea;
    background: #f8f9ff;
}

.agent-info h4 {
    color: #333;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
}

.agent-info p {
    color: #666;
    margin: 0;
    font-size: 0.9rem;
}

.form-actions {
    display: flex;
    justify-content: center;
    padding-top: 1rem;
    border-top: 1px solid #e9ecef;
}

.btn {
    padding: 1rem 2rem;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
    transform: translateY(-2px);
}
</style>
{% endblock %}
